<html>
    <head>
        <title>Knights' Chase</title>
    </head>
    <body>
        <h1>Welcome to Knights' Chase</h1>
        <style>
            /* Gemini just spat out this CSS when I googled table style. it works, so why change it? */
            table {
                table-layout: fixed; /* Ensures equal width columns */
                border-collapse: collapse; /* Merges borders */
            }
            
            table td {
                width: 50px; /* Equal Width */
                height: 50px; /* Equal Height */
                border: 1px solid black;
                text-align: center; /* Optional: Center content */
                vertical-align: middle; /* Optional: Center content */
                padding: 0; /* Remove padding to keep size precise */
            }
        </style>
        <form>
            <p><label for="p1name">Player 1:</label><input id="0" name="Player 1" value="p1" onkeyup="updateName(this)" /></p>
            <p><label for="p2name">Player 2:</label><input id="1" name="Player 2" value="p2" onkeyup="updateName(this)" /></p>
            <p><label for="hints">Show hints:</label><input id="hints" name="hints" type="checkbox" onchange="toggleHints(this)" /></p>
        </form>
        <table id="board"></table>


        <script>
            // Horrible mix of global vars and funcs which take them in!
            const boardlength = 8;
            const players = [];
            const displayBoard = document.getElementById('board');
            let board = [];
            let showHints = false;
            startGame();

            function initBoard(board) {
                displayBoard.innerHTML = '';
                for (let rowIdx = 0; rowIdx < boardlength; rowIdx++) {
                    const row = document.createElement('tr');
                    displayBoard.appendChild(row);
                    for (let colIdx = 0; colIdx < boardlength; colIdx++) {
                        const cell = document.createElement('td');
                        cell.addEventListener('click', () => board[rowIdx][colIdx].handler(board, cb));
                        row.appendChild(cell);
                    }
                }

                function cb () {
                    activePlayerIdx = (activePlayerIdx + 1) % players.length;
                    renderBoard(displayBoard, board, players);
                }
            }

            function renderBoard(displayBoard, board, players) {
                const activePlayer = players[activePlayerIdx];
                
                let hasOptions = false;
                for (let rowIdx = 0; rowIdx < boardlength; rowIdx++) {
                    const row = displayBoard.childNodes[rowIdx];
                    for (let colIdx = 0; colIdx < boardlength; colIdx++) {
                        const cell = board[rowIdx][colIdx];
                        const gCell = row.childNodes[colIdx];
                        gCell.innerText = cell.marker;
                        
                        if (rowIdx == activePlayer.x && colIdx == activePlayer.y) {
                            gCell.style.backgroundColor = 'FFCCCC';
                        } else if (
                            cell.marker != '//' &&
                            (
                                Math.abs(activePlayer.x - rowIdx) == 2 && Math.abs(activePlayer.y - colIdx) == 1 ||
                                Math.abs(activePlayer.x - rowIdx) == 1 && Math.abs(activePlayer.y - colIdx) == 2
                            )
                        ) {
                            cell.isAllowed = true;
                            hasOptions = true;
                            if (showHints) {
                                gCell.style.backgroundColor = 'CCFFCC';
                            } else {
                                gCell.style.backgroundColor = 'FFFFFF';
                            }
                        } else if (cell.marker == '//') {
                            gCell.style.backgroundColor = 'CCCCCC';
                        }else {
                            gCell.style.backgroundColor = 'FFFFFF';
                            cell.isAllowed = false;
                        }
                    }
                }
                if (!hasOptions) {
                    alert(`No options! ${activePlayer.name} lose!`);
                    startGame();
                }
            }
            
            function buidlBoard(boardlength) {
                const board = new Array(boardlength);
                for (let i = 0; i < boardlength; i++) {
                    board[i] = new Array(boardlength);
                    for (let j = 0; j < boardlength; j++) {
                        const newCell = new BoardCell(i, j);
                        board[i][j] = newCell;
                    }
                }

                return board;
            }

            function BoardCell(x, y) {
                this.marker = '';
                this.x = x;
                this.y = y;
                this.isAllowed = false;
                this.handler = (board, cb) => onClick(this, board, cb);
            }

            function onClick(cell, board, cb) {
                if (cell.isAllowed) {
                    const activePlayer = players[activePlayerIdx];
                    if (cell.marker && cell.marker != '//') {
                        alert(`${activePlayer.name} wins!`);
                        startGame();

                        return;
                    }
                    const homeCell = board[activePlayer.x][activePlayer.y];
                    cell.marker = activePlayer.marker;
                    homeCell.marker = '//';

                    activePlayer.x = cell.x;
                    activePlayer.y = cell.y;
                    activePlayerIdx = (activePlayerIdx + 1) % players.length;
                    renderBoard(displayBoard, board, players);
                } else {
                    alert('Cant go here! Try again.');
                }
            }

            function startGame() {
                activePlayerIdx = 0;
                board = buidlBoard(boardlength);

                players[0] = {x: 0, y: 0};
                players[1] = {x: boardlength - 1, y: boardlength - 1};
                initBoard(board);
                updateName(document.getElementById('0'));
                updateName(document.getElementById('1'));

                players.forEach(({ x, y, marker }) => board[x][y].marker = marker);
                renderBoard(displayBoard, board, players);
            }

            function updateName({id, value: name}) {
                const playerIdx = Number(id);
                const player = players[playerIdx];

                player.name = name;
                player.marker = name.substr(0,3) + (name.length > 3 ? '.' : '') || 'p' + (playerIdx + 1).toString();
                board[player.x][player.y].marker = player.marker;

                renderBoard(displayBoard, board, players);
            }

            function toggleHints(showHintsBox) {
                showHints = showHintsBox.checked;
                renderBoard(displayBoard, board, players);
            }
        </script>
    </body>
</html>